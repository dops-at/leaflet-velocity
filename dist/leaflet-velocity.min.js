"use strict";L.DomUtil.setTransform||(L.DomUtil.setTransform=function(t,e,o){var a=e||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+a.x+"px,"+a.y+"px)":"translate3d("+a.x+"px,"+a.y+"px,0)")+(o?" scale("+o+")":"")}),L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,L.setOptions(this,t)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_onLayerDidMove:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this.drawLayer()},getEvents:function(){var t={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&L.Browser.any3d&&(t.zoomanim=this._animateZoom),t},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this.tiles={};var e=this._map.getSize();this._canvas.width=e.x,this._canvas.height=e.y;var o=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(o?"animated":"hide")),this.options.pane.appendChild(this._canvas),t.on(this.getEvents(),this);var a=this._delegate||this;a.onLayerDidMount&&a.onLayerDidMount(),this.needRedraw();var i=this;setTimeout(function(){i._onLayerDidMove()},0)},onRemove:function(t){var e=this._delegate||this;e.onLayerWillUnmount&&e.onLayerWillUnmount(),this.options.pane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},drawLayer:function(){var t=this._map.getSize(),e=this._map.getBounds(),o=this._map.getZoom(),a=this._map.options.crs.project(this._map.getCenter()),i=this._map.options.crs.project(this._map.containerPointToLatLng(this._map.getSize())),n=this._delegate||this;n.onDrawLayer&&n.onDrawLayer({layer:this,canvas:this._canvas,bounds:e,size:t,zoom:o,center:a,corner:i}),this._frame=null},_setTransform:function(t,e,o){var a=e||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+a.x+"px,"+a.y+"px)":"translate3d("+a.x+"px,"+a.y+"px,0)")+(o?" scale("+o+")":"")},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),o=L.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center):this._map._getCenterOffset(t.center)._multiplyBy(-e).subtract(this._map._getMapPanePos());L.DomUtil.setTransform(this._canvas,o,e)}}),L.canvasLayer=function(t){return new L.CanvasLayer(t)},L.Control.Velocity=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable",angleConvention:"bearingCCW",showCardinal:!1,speedUnit:"m/s",directionString:"Direction",speedString:"Speed",onAdd:null,onRemove:null},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-velocity"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this.options.leafletVelocity.options.onAdd&&this.options.leafletVelocity.options.onAdd(),this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this),this.options.leafletVelocity.options.onRemove&&this.options.leafletVelocity.options.onRemove()},vectorToSpeed:function(t,e,o){var a=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===o?this.meterSec2kilometerHour(a):"kt"===o?this.meterSec2Knots(a):"mph"===o?this.meterSec2milesHour(a):a},vectorToDegrees:function(t,e,o){o.endsWith("CCW")&&(e=0<e?e=-e:Math.abs(e));var a=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),i=180*Math.atan2(t/a,e/a)/Math.PI+180;return"bearingCW"!==o&&"meteoCCW"!==o||360<=(i+=180)&&(i-=360),i},degreesToCardinalDirection:function(t){var e="";return 0<=t&&t<11.25||348.75<=t?e="N":11.25<=t&&t<33.75?e="NNW":33.75<=t&&t<56.25?e="NW":56.25<=t&&t<78.75?e="WNW":78.25<=t&&t<101.25?e="W":101.25<=t&&t<123.75?e="WSW":123.75<=t&&t<146.25?e="SW":146.25<=t&&t<168.75?e="SSW":168.75<=t&&t<191.25?e="S":191.25<=t&&t<213.75?e="SSE":213.75<=t&&t<236.25?e="SE":236.25<=t&&t<258.75?e="ESE":258.75<=t&&t<281.25?e="E":281.25<=t&&t<303.75?e="ENE":303.75<=t&&t<326.25?e="NE":326.25<=t&&t<348.75&&(e="NNE"),e},meterSec2Knots:function(t){return t/.514},meterSec2kilometerHour:function(t){return 3.6*t},meterSec2milesHour:function(t){return 2.23694*t},_onMouseMove:function(t){var e=this.options.leafletVelocity._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y)),o=this.options.leafletVelocity._windy.interpolatePoint(e.lng,e.lat),a="";if(o&&!isNaN(o[0])&&!isNaN(o[1])&&o[2]){var i=this.vectorToDegrees(o[0],o[1],this.options.angleConvention),n=this.options.showCardinal?" (".concat(this.degreesToCardinalDirection(i),") "):"";a="<strong> ".concat(this.options.velocityType," ").concat(this.options.directionString,": </strong> ").concat(i.toFixed(2),"Â°").concat(n,", <strong> ").concat(this.options.velocityType," ").concat(this.options.speedString,": </strong> ").concat(this.vectorToSpeed(o[0],o[1],this.options.speedUnit).toFixed(2)," ").concat(this.options.speedUnit)}else a=this.options.emptyString;this._container.innerHTML=a}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.velocity=function(t){return new L.Control.Velocity(t)},L.VelocityLayer=(L.Layer?L.Layer:L.Class).extend({options:{displayValues:!0,displayOptions:{velocityType:"Velocity",position:"bottomleft",emptyString:"No velocity data"},maxVelocity:10,colorScale:null,customColorMap:null,particleColor:"default",data:null,showColorOverlay:!1,overlayOpacity:.5,overlaySmoothing:"high",viewportOnly:!1,autoUpdateOnMove:!0},_map:null,_canvasLayer:null,_overlayCanvasLayer:null,_windy:null,_context:null,_overlayContext:null,_timer:0,_mouseControl:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._paneName=this.options.paneName||"overlayPane";var e=t._panes.overlayPane;t.getPane&&(e=(e=t.getPane(this._paneName))||t.createPane(this._paneName));var o=e,a=e;if(this.options.showColorOverlay&&t.createPane){var i=this._paneName+"-overlay";(o=t.getPane(i))||((o=t.createPane(i)).style.zIndex=200);var n=this._paneName+"-particles";(a=t.getPane(n))||((a=t.createPane(n)).style.zIndex=210)}this.options.showColorOverlay&&this._createOverlayLayer(o),this._canvasLayer=L.canvasLayer({pane:a}).delegate(this),this._canvasLayer.addTo(t),this._map=t},_createOverlayLayer:function(t){if(!this._overlayCanvasLayer){this._overlayCanvasLayer=L.canvasLayer({pane:t}).delegate(this),this._overlayCanvasLayer.addTo(this._map);var e=this;setTimeout(function(){void 0!==e.options.overlayOpacity&&e._overlayCanvasLayer&&e._overlayCanvasLayer._canvas&&(e._overlayCanvasLayer._canvas.style.opacity=e.options.overlayOpacity)},0)}},onRemove:function(t){this._destroyWind()},setData:function(t){this.options.data=t,this._windy&&(this._windy.setData(t),this._clearAndRestart()),this.fire("load")},setOpacity:function(t){this._canvasLayer.setOpacity(t),this._overlayCanvasLayer&&this._overlayCanvasLayer._canvas&&(this._overlayCanvasLayer._canvas.style.opacity=this.options.overlayOpacity)},setOverlayOpacity:function(t){this.options.overlayOpacity=t,this._overlayCanvasLayer&&this._overlayCanvasLayer._canvas&&(this._overlayCanvasLayer._canvas.style.opacity=t)},setOverlaySmoothing:function(t){this.options.overlaySmoothing=t,this.options.showColorOverlay&&this._windy&&this._windy.field&&this._drawColorOverlay()},toggleColorOverlay:function(){this.setOptions({showColorOverlay:!this.options.showColorOverlay})},toggleViewportOnly:function(){this.setOptions({viewportOnly:!this.options.viewportOnly})},setViewportOnly:function(t){this.setOptions({viewportOnly:t})},setOptions:function(t){if(this.options=Object.assign(this.options,t),t.hasOwnProperty("displayOptions")&&(this.options.displayOptions=Object.assign(this.options.displayOptions,t.displayOptions),this._initMouseHandler(!0)),t.hasOwnProperty("data")&&(this.options.data=t.data),this._windy&&(this._windy.setOptions(t),t.hasOwnProperty("data")&&this._windy.setData(t.data),this._clearAndRestart()),t.hasOwnProperty("viewportOnly")&&(this.options.viewportOnly&&this.options.autoUpdateOnMove?this._map&&(this._map.on("moveend",this._onViewportChange,this),this._map.on("zoomend",this._onViewportChange,this)):this._map&&(this._map.off("moveend",this._onViewportChange,this),this._map.off("zoomend",this._onViewportChange,this))),t.hasOwnProperty("overlayOpacity")&&this._overlayCanvasLayer&&this._overlayCanvasLayer._canvas&&(this._overlayCanvasLayer._canvas.style.opacity=this.options.overlayOpacity,this.options.showColorOverlay&&this._windy&&this._windy.field&&this._drawColorOverlay()),t.hasOwnProperty("showColorOverlay"))if(this.options.showColorOverlay){if(!this._overlayCanvasLayer){var e=this._map._panes.overlayPane;if(this._map.getPane&&this._map.createPane){var o=(this._paneName||"overlayPane")+"-overlay";(e=this._map.getPane(o))||((e=this._map.createPane(o)).style.zIndex=200)}this._createOverlayLayer(e)}this._windy&&this._windy.field&&this._drawColorOverlay()}else this._overlayContext&&this._overlayCanvasLayer&&this._overlayCanvasLayer._canvas&&this._overlayContext.clearRect(0,0,this._overlayCanvasLayer._canvas.width,this._overlayCanvasLayer._canvas.height);this.fire("load")},onDrawLayer:function(t,e){var o=this;this._windy?this.options.data&&(this._timer&&clearTimeout(o._timer),this._timer=setTimeout(function(){o._startWindy()},750)):this._initWindy(this)},_startWindy:function(){var t=this._map.getBounds(),e=this._map.getSize();this._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},_initWindy:function(t){if(t._canvasLayer&&t._canvasLayer._canvas){var e=Object.assign({canvas:t._canvasLayer._canvas,map:this._map,onFieldReady:function(){t.options.showColorOverlay&&t._overlayContext&&t._drawColorOverlay()}},t.options);this._windy=new Windy(e),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.options.showColorOverlay&&this._overlayCanvasLayer&&this._overlayCanvasLayer._canvas&&(this._overlayContext=this._overlayCanvasLayer._canvas.getContext("2d"),this._overlayCanvasLayer._canvas.classList.add("color-overlay")),this.onDrawLayer(),this._map.on("dragstart",t._windy.stop),this._map.on("dragend",t._clearAndRestart),this._map.on("zoomstart",t._windy.stop),this._map.on("zoomend",t._clearAndRestart),this._map.on("resize",t._clearWind),this.options.viewportOnly&&this.options.autoUpdateOnMove&&(this._map.on("moveend",t._onViewportChange,this),this._map.on("zoomend",t._onViewportChange,this)),this._initMouseHandler(!1)}else console.error("Canvas layer not properly initialized")},_initMouseHandler:function(t){if(t&&(this._map.removeControl(this._mouseControl),this._mouseControl=!1),!this._mouseControl&&this.options.displayValues){var e=this.options.displayOptions||{};(e.leafletVelocity=this)._mouseControl=L.control.velocity(e).addTo(this._map)}},_onViewportChange:function(){this._viewportTimer&&clearTimeout(this._viewportTimer);var t=this;this._viewportTimer=setTimeout(function(){t.options.viewportOnly&&t._windy&&(t._clearAndRestart(),setTimeout(function(){t._windy&&t._windy.logFilteringSummary&&t._windy.logFilteringSummary()},600))},300)},_clearAndRestart:function(){this._context&&this._context.clearRect(0,0,3e3,3e3),this._overlayContext&&this._overlayContext.clearRect(0,0,3e3,3e3),this._windy&&this._startWindy()},_clearWind:function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._overlayContext&&this._overlayContext.clearRect(0,0,3e3,3e3)},_drawColorOverlay:function(){if(this._overlayContext&&this._windy&&this._windy.field){var t=this._overlayCanvasLayer._canvas;if(t){var e=t.width,o=t.height;this._overlayContext.clearRect(0,0,e,o);try{var a;this.options.customColorMap&&Array.isArray(this.options.customColorMap)?(a=this.options.customColorMap,console.log("Using custom color map:",{colors:a.slice(0,3),totalColors:a.length})):a=this.options.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193)","rgb(151,218,168)","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];var i=a.map(function(t){if(t.startsWith&&t.startsWith("#")){var e=t.slice(1);return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}var o=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return o?[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])]:[0,0,0]});console.log("Color scale debug:",{originalColors:a.slice(0,3),parsedColors:i.slice(0,3),totalColors:i.length});var n,r,s=this.options.minVelocity||0,l=this.options.maxVelocity||10,h=this._windy.field;switch(console.log("Alpha and velocity range:",{minVelocity:s,maxVelocity:l,alpha:255,overlayOpacity:this.options.overlayOpacity}),this.options.overlaySmoothing||"high"){case"low":n=32,r=0;break;case"medium":n=24,r=.5;break;case"high":n=16,r=1;break;case"ultra":n=12,r=1.5;break;default:n=16,r=1}for(var c=[],d={sampleCount:0,velocitySum:0,maxFound:0,minFound:1/0,normalizedSamples:[],totalSamplePoints:0,filteredOutPoints:0,validVelocityPoints:0},y=0;y<o;y+=n){c[y]=c[y]||[];for(var p=0;p<e;p+=n)try{d.totalSamplePoints++;var v=!0;if(this.options.viewportOnly&&this._windy.isViewportOnlyEnabled&&this._windy.isViewportOnlyEnabled()){var u=this._windy.invert(p,y);u&&this._windy.isInViewport&&(v=this._windy.isInViewport(u[0],u[1]))}if(v){var m=h(p,y);if(m&&3<=m.length&&null!==m[2]&&!isNaN(m[2])){d.validVelocityPoints++;var _=m[2],f=Math.max(0,Math.min(1,(_-s)/(l-s)));c[y][p]=f,d.sampleCount++,d.velocitySum+=_,d.maxFound=Math.max(d.maxFound,_),d.minFound=Math.min(d.minFound,_),d.normalizedSamples.length<10&&d.normalizedSamples.push({raw:_,normalized:f,position:[p,y]})}else c[y][p]=0}else c[y][p]=0,d.filteredOutPoints++}catch(t){c[y][p]=0}}console.log("ð¨ Color Overlay Debug Info:",{mode:"Color Overlay",totalSamplePoints:d.totalSamplePoints,validVelocityPoints:d.validVelocityPoints,filteredOutPoints:d.filteredOutPoints,drawnPoints:d.sampleCount,viewportOnlyEnabled:this.options.viewportOnly,filteringRate:0<d.totalSamplePoints?(d.filteredOutPoints/d.totalSamplePoints*100).toFixed(1)+"%":"0%",avgVelocity:0<d.sampleCount?(d.velocitySum/d.sampleCount).toFixed(2):0,velocityRange:{min:s,max:l,actualMin:d.minFound!==1/0?d.minFound.toFixed(2):"N/A",actualMax:d.maxFound.toFixed(2)},colorCount:i.length,sampleGrid:n}),this._drawSmoothGradient(c,n,e,o,i,255,r),console.log("Smooth color overlay drawn successfully")}catch(t){console.error("Error drawing color overlay:",t)}}else console.log("Overlay canvas not available")}else console.log("Color overlay not ready:",{context:!!this._overlayContext,windy:!!this._windy,field:!(!this._windy||!this._windy.field)})},_drawSmoothGradient:function(t,e,o,a,s,l,i){var n,r,h,c,d,y,p=this._overlayContext.createImageData(o,a),v=p.data;function u(t){if(t<=0)return[0,0,0,0];var e=Math.min(s.length-1,Math.floor(t*s.length)),o=Math.min(s.length-1,e+1),a=t*s.length-e,i=s[e],n=s[o],r=[Math.round(i[0]+(n[0]-i[0])*a),Math.round(i[1]+(n[1]-i[1])*a),Math.round(i[2]+(n[2]-i[2])*a),l];return Math.random()<.001&&console.log("Color mapping:",{normalizedMagnitude:t,colorIndex:e,color:r,rgb1:i,rgb2:n}),r}for(var m=0;m<a;m++)for(var _=0;_<o;_++){var f=4*(m*o+_),g=Math.floor(_/e)*e,w=Math.floor(m/e)*e,C=Math.min(g+e,o-1),L=Math.min(w+e,a-1),x=t[w]&&void 0!==t[w][g]?t[w][g]:0,O=t[L]&&void 0!==t[L][g]?t[L][g]:0,M=t[w]&&void 0!==t[w][C]?t[w][C]:0,P=t[L]&&void 0!==t[L][C]?t[L][C]:0,b=u(g===C&&w===L?x:g===C?x+(m-w)/(L-w)*(O-x):w===L?x+(_-g)/(C-g)*(M-x):((y=L)-(r=m))/(y-(c=w))*(((d=C)-(n=_))/(d-(h=g))*x+(n-h)/(d-h)*M)+(r-c)/(y-c)*((d-n)/(d-h)*O+(n-h)/(d-h)*P));f<v.length-3&&(v[f]=b[0],v[1+f]=b[1],v[2+f]=b[2],v[3+f]=b[3])}this._overlayContext.putImageData(p,0,0),0<i&&(this._overlayContext.filter="blur("+i+"px)",this._overlayContext.globalCompositeOperation="source-over",this._overlayContext.drawImage(this._overlayCanvasLayer._canvas,0,0),this._overlayContext.filter="none")},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._overlayContext&&this._overlayContext.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._canvasLayer&&this._map.removeLayer(this._canvasLayer),this._overlayCanvasLayer&&this._map.removeLayer(this._overlayCanvasLayer)}}),L.velocityLayer=function(t){return new L.VelocityLayer(t)};var Windy=function(h){function i(t,e,o,a,i,n){var r=1-t,s=1-e,l=r*s,h=t*s,c=r*e,d=t*e,y=o[0]*l+a[0]*h+i[0]*c+n[0]*d,p=o[1]*l+a[1]*h+i[1]*c+n[1]*d;return[y,p,Math.sqrt(y*y+p*p)]}function y(t){var e=null,o=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":e=t;break;case"1,3":case"2,3":o=t;break;default:t}}),function(t,e){var o=t.data,a=e.data;return{header:t.header,data:function(t){return[o[t],a[t]]},interpolate:i}}(e,o)}function n(a,s,t){function l(t,e){var o=a[Math.round(t)];return o&&o[Math.round(e)]||E}l.release=function(){a=[]},l.randomize=function(t){var e,o,a=0,i=0,n=T&&q?50:0;do{if(e=Math.round(Math.floor(Math.random()*s.width)+s.x),o=Math.round(Math.floor(Math.random()*s.height)+s.y),T&&q&&i<n){var r=B(e,o);if(r&&!H(r[0],r[1])){i++;continue}}if(null!==l(e,o)[2])break}while(a++<30);return t.x=e,t.y=o,t},t(s,l)}function r(t){return t/180*Math.PI}function s(a,c){var e,o,d=(e=O,o=M,V.indexFor=function(t){return Math.max(0,Math.min(V.length-1,Math.round((t-e)/(o-e)*(V.length-1))))},V),y=d.map(function(){return[]}),t=Math.round(a.width*a.height*S);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=F);for(var i="rgba(0, 0, 0, ".concat(R,")"),n=[],r=0;r<t;r++)n.push(c.randomize({age:Math.floor(Math.random()*P)+0}));var s=h.canvas.getContext("2d");s.lineWidth=b,s.fillStyle=i,s.globalAlpha=.6;var l=Date.now();!function t(){x=requestAnimationFrame(t);var e=Date.now(),o=e-l;D<o&&(l=e-o%D,function(){y.forEach(function(t){t.length=0});var h={totalParticles:n.length,visibleParticles:0,filteredOutParticles:0,validFieldParticles:0,drawnParticles:0};n.forEach(function(t){t.age>P&&(c.randomize(t).age=0);var e=t.x,o=t.y,a=c(e,o),i=a[2];if(null===i)t.age=P;else{h.validFieldParticles++;var n=e+a[0],r=o+a[1],s=!0;if(T&&q){var l=B(e,o);l&&isFinite(l[0])&&isFinite(l[1])?((s=H(l[0],l[1]))?h.visibleParticles++:h.filteredOutParticles++,h.validFieldParticles<=10&&console.log("ð§ª Particle ".concat(h.validFieldParticles,": screen(").concat(e.toFixed(1),", ").concat(o.toFixed(1),") -> geo(").concat(l[0].toFixed(4),", ").concat(l[1].toFixed(4),") -> ").concat(s?"VISIBLE":"FILTERED"))):(s=!1,h.filteredOutParticles++)}else h.visibleParticles++;null!==c(n,r)[2]&&s?(t.xt=n,t.yt=r,y[d.indexFor(i)].push(t),h.drawnParticles++):(t.x=n,t.y=r)}t.age+=1}),Math.random()<.005&&console.log("ð¯ Particle Stats (visual only):",{totalParticles:h.totalParticles,drawnParticles:h.drawnParticles,note:"Particles are just visual elements - real filtering happens at data interpolation level"})}(),s.globalCompositeOperation="destination-in",s.fillRect(a.x,a.y,a.width,a.height),s.globalCompositeOperation="lighter",s.globalAlpha=0===R?0:.9*R,y.forEach(function(t,e){0<t.length&&(s.beginPath(),s.strokeStyle=d[e],t.forEach(function(t){s.moveTo(t.x,t.y),s.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),s.stroke())}))}()}function l(t){if(T){var e=180*t.west/Math.PI,o=180*t.east/Math.PI,a=180*t.south/Math.PI,i=180*t.north/Math.PI,n=.05*Math.abs(o-e),r=.05*Math.abs(i-a);(q={west:e-n,east:o+n,south:a-r,north:i+r}).west<-180&&(q.west=-180),180<q.east&&(q.east=180),q.south<-90&&(q.south=-90),90<q.north&&(q.north=90),console.log("ð¯ Viewport bounds set for filtering:",{original:{west:e.toFixed(4),east:o.toFixed(4),south:a.toFixed(4),north:i.toFixed(4)},withBuffer:{west:q.west.toFixed(4),east:q.east.toFixed(4),south:q.south.toFixed(4),north:q.north.toFixed(4)},bufferSize:{lon:n.toFixed(4),lat:r.toFixed(4)}}),W.totalRequests=0,W.filteredOutRequests=0,W.validDataPoints=0,W.resetTime=Date.now(),H.debugCount=0}else q=null,console.log("ð¯ Viewport filtering disabled - processing all data")}function c(){if(T&&0<W.totalRequests){var t=W.validDataPoints,e=W.totalRequests,o=W.filteredOutRequests,a=(o/e*100).toFixed(1);console.log("ðºï¸ VIEWPORT FILTERING SUMMARY (after map move/zoom):",{status:"Viewport-only mode ENABLED",currentlyDisplayed:t+" data points",wholeDataset:e+" data points",filtered:o+" data points ("+a+"% filtered)",performance:0<o?"Optimized - showing only viewport data":"No filtering needed for current view",viewportBounds:q?{west:q.west.toFixed(2),east:q.east.toFixed(2),south:q.south.toFixed(2),north:q.north.toFixed(2)}:"Not set"})}else T||console.log("ðºï¸ VIEWPORT FILTERING SUMMARY (after map move/zoom):",{status:"Viewport-only mode DISABLED",displaying:"All available data (no filtering)",performance:"Standard mode - processing entire dataset"});W.totalRequests=0,W.filteredOutRequests=0,W.validDataPoints=0,W.resetTime=Date.now()}var p,v,u,m,_,f,g,w,C,x,O=h.minVelocity||0,M=h.maxVelocity||10,d=(h.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),P=h.particleAge||90,b=h.lineWidth||1,S=h.particleMultiplier||1/300,F=Math.pow(window.devicePixelRatio,1/3)||1.6,o=h.frameRate||15,D=1e3/o,R=.97,T=h.viewportOnly||!1,V=(h.autoUpdateOnMove,h.colorScale||["rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)","rgb(0,0,0)"]),E=[NaN,NaN,null],N=h.data,W={totalRequests:0,filteredOutRequests:0,validDataPoints:0,resetTime:Date.now()},z=function(t,e){if(!v)return null;var o,a=I(t-m,360)/f,i=(_-e)/g,n=Math.floor(a),r=n+1,s=Math.floor(i),l=s+1;if(o=v[s]){var h=o[n],c=o[r];if(A(h)&&A(c)&&(o=v[l])){var d=o[n],y=o[r];if(A(d)&&A(y))return p.interpolate(a-n,i-s,h,c,d,y)}}return null},A=function(t){return null!=t},I=function(t,e){return t-e*Math.floor(t/e)},U=function(t,e,o,a,i){var n=2*Math.PI,r=e<0?5:-5,s=o<0?5:-5,l=k(o,e+r),h=k(o+s,e),c=Math.cos(o/360*n);return[(l[0]-a)/r/c,(l[1]-i)/r/c,(h[0]-a)/s,(h[1]-i)/s]},B=function(t,e,o){var a=h.map.containerPointToLatLng(L.point(t,e));return[a.lng,a.lat]},k=function(t,e,o){var a=h.map.latLngToContainerPoint(L.latLng(t,e));return[a.x,a.y]},q=null,H=function t(e,o){if(!T||!q)return!0;if("number"!=typeof e||"number"!=typeof o||!isFinite(e)||!isFinite(o))return!1;var a=!1;a=q.west<=q.east?e>=q.west&&e<=q.east:e>=q.west||e<=q.east;var i=o>=q.south&&o<=q.north,n=a&&i;return void 0===t.debugCount&&(t.debugCount=0,console.log("ð¯ Viewport bounds for filtering:",q)),t.debugCount<10&&(console.log("ð Viewport check [".concat(t.debugCount,"]: (").concat(e.toFixed(4),", ").concat(o.toFixed(4),") -> ").concat(n?"IN":"OUT")),console.log("   Bounds: W:".concat(q.west.toFixed(4)," E:").concat(q.east.toFixed(4)," S:").concat(q.south.toFixed(4)," N:").concat(q.north.toFixed(4))),t.debugCount++),n},j=function(){G.field&&G.field.release(),x&&cancelAnimationFrame(x)},G={params:h,start:function(e,o,a,t){var i={south:r(t[0][1]),north:r(t[1][1]),east:r(t[1][0]),west:r(t[0][0]),width:o,height:a};j(),l(i),console.log("ðï¸ Building grid with viewport filtering:",T?"ENABLED":"DISABLED"),function(t,e){var o=!0;t.length<2&&(o=!1),o||console.log("Windy Error: data must have at least two components (u,v)");var a=(p=y(t)).header;if(a.hasOwnProperty("gridDefinitionTemplate")&&0!=a.gridDefinitionTemplate&&(o=!1),o||console.log("Windy Error: Only data with Latitude_Longitude coordinates is supported"),o=!0,m=a.lo1,_=a.la1,f=a.dx,g=a.dy,w=a.nx,C=a.ny,a.hasOwnProperty("scanMode")){var i=a.scanMode.toString(2),n=(i=("0"+i).slice(-8)).split("").map(Number).map(Boolean);n[0]&&(f=-f),n[1]&&(g=-g),n[2]&&(o=!1),n[3]&&(o=!1),n[4]&&(o=!1),n[5]&&(o=!1),n[6]&&(o=!1),n[7]&&(o=!1),o||console.log("Windy Error: Data with scanMode: "+a.scanMode+" is not supported.")}(u=new Date(a.refTime)).setHours(u.getHours()+a.forecastTime),v=[];for(var r=0,s=360<=Math.floor(w*f),l=0;l<C;l++){for(var h=[],c=0;c<w;c++,r++){var d=p.data(r);h[c]=d}s&&h.push(h[0]),v[l]=h}e({date:u,interpolate:z})}(N,function(t){!function(_,f,t,o){var g={},e=(t.south-t.north)*(t.west-t.east),w=d*Math.pow(e,.4),C=[],a=f.x;function i(t){for(var e,o,a,i,n,r,s,l,h,c,d=[],y=f.y;y<=f.yMax;y+=2){var p=B(t,y);if(p){var v=p[0],u=p[1];if(isFinite(v)){var m=_.interpolate(v,u);m&&(e=g,o=v,a=u,i=t,n=y,r=w,void 0,l=(s=m)[0]*r,h=s[1]*r,c=U(e,o,a,i,n),s[0]=c[0]*l+c[2]*h,s[1]=c[1]*l+c[3]*h,m=s,d[y+1]=d[y]=m)}}}C[t+1]=C[t]=d}!function t(){for(var e=Date.now();a<f.width;)if(i(a),a+=2,1e3<Date.now()-e)return void setTimeout(t,25);n(C,f,o)}()}(t,function(t,e,o){var a=t[0],i=t[1],n=Math.round(a[0]),r=Math.max(Math.floor(a[1],0),0);Math.min(Math.ceil(i[0],e),e-1);return{x:n,y:r,xMax:e,yMax:Math.min(Math.ceil(i[1],o),o-1),width:e,height:o}}(e,o,a),i,function(t,e){G.field=e,s(t,e),h.onFieldReady&&h.onFieldReady(),setTimeout(c,500)})})},stop:j,createField:n,interpolatePoint:z,setData:function(t){N=t},setOptions:function(t){if(t.hasOwnProperty("minVelocity")&&(O=t.minVelocity),t.hasOwnProperty("maxVelocity")&&(M=t.maxVelocity),t.hasOwnProperty("velocityScale")&&(d=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1)),t.hasOwnProperty("particleAge")&&(P=t.particleAge),t.hasOwnProperty("lineWidth")&&(b=t.lineWidth),t.hasOwnProperty("particleMultiplier")&&(S=t.particleMultiplier),t.hasOwnProperty("opacity")&&(R=+t.opacity),t.hasOwnProperty("frameRate")&&(o=t.frameRate),D=1e3/o,t.hasOwnProperty("viewportOnly")){var e=T;T=t.viewportOnly,console.log("ð§ setOptions: viewportOnly changed from",e,"to",T)}t.hasOwnProperty("autoUpdateOnMove")&&t.autoUpdateOnMove},setViewportBounds:l,isInViewport:H,invert:B,getCurrentViewportBounds:function(){return q},isViewportOnlyEnabled:function(){return T},logFilteringSummary:c};return G};window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});